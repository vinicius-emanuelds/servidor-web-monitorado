# **MONITORANDO UM SERVIDOR WEB**

## **Vis√£o Geral**
Este projeto tem como objetivo configurar um servidor web na AWS com monitoramento autom√°tico. Ele inclui:
- Cria√ß√£o de uma **VPC** com sub-redes p√∫blicas e privadas.
- Configura√ß√£o de uma **inst√¢ncia EC2** e instala√ß√£o do **Nginx**.
- Cria√ß√£o de uma **p√°gina HTML** para testes.
- Implementa√ß√£o de um **script de monitoramento** com envio de notifica√ß√£o para o **Telegram.
- Op√ß√£o de **automatiza√ß√£o** com **User Data** e **CloudFormation**.

---

## Prepara√ß√£o
Antes de iniciarmos as configura√ß√µes do ambiente AWS e a cria√ß√£o do servidor, √© preciso configurar nosso setup para que este se conecte com a inst√¢ncia AWS. Ainda, precisamos configurar todo o processo de webhook com o Telegram.

### Configurando o AWS CLI
  Basicamente, iremos nos conectar √† inst√¢ncia atrav√©s do terminal, via linha de comando. Para isto, iremos configurar o **AWS CLI** em nosso setup. [Clique aqui](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html) para acessar a documenta√ß√£o oficial, com um passo a passo detalhado para a instala√ß√£o e configura√ß√£o.

### Configurando o Webhook no Telegram
#### **Passo 1: Criar o Bot**
1. No Telegram, procure por `@BotFather`.
2. Inicie uma conversa e envie o comando `/newbot`.
3. O BotFather pedir√° um nome para o bot (exemplo: `MonitoramentoBot`).
4. Em seguida, pedir√° um nome de usu√°rio √∫nico, que deve terminar com "bot" (exemplo: `MonitoramentoServer_bot`).
5. Ap√≥s a cria√ß√£o, o BotFather fornecer√° um **Token de API**, que ser√° necess√°rio para enviar mensagens. **Guarde esse token**.

#### **Passo 2: Obter o Chat ID**
Para enviar mensagens, precisamos saber para onde o bot deve envi√°-las.
1. Acesse `https://t.me/RawDataBot` no Telegram e inicie uma conversa.
2. Ele fornecer√° seu `chat_id`. **Guarde essa informa√ß√£o**

#### **Passo 3: Iniciar o Bot**
Para enviar mensagens atrav√©s do webhook, precisamos "iniciar" nosso bot para que ele reconhe√ßa nosso chat_id.
1. No Telegram, procure por `@MonitoramentoBot` (use o nome que voc√™ deu ao bot.
2. Inicie uma conversa enviando o comando `/start.

---

## **Etapa 1: Configura√ß√£o do Ambiente**

### **1. Criar a VPC**
Agora vamos criar uma VPC na AWS com 4 sub-redes (2 privadas e 2 p√∫blicas), com um internet gateway conectado √† uma das sub-redes p√∫blicas.

- Ap√≥s logar no console AWS, selecione VPC (ou digite na barra de busca).
![1 Dashboard.png](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/1%20Dashboard.png)

- Clique em *Create VPC*
![2 VPC.png](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/2%20VPC.png)

- Aplique as configura√ß√µes abaixo e clique em *Create VPC*
![2.1 VPC.png](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/2.1%20VPC.png)
![2.2 VPC.png](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/2.2%20VPC.png)
- Se as configura√ß√µes estiverem corretas, o fluxo ser similar √† esse:
![<2.3 VPC.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/2.3%20VPC.png)

### Criando um Security Group
- No dashboard, clique em EC2. Depois, na se√ß√£o √† esquerda, selecione *Secuity Group*
![<3 SG.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/3%20SG.png)

- Clique em *Create Security Group*
![<3.1 SG.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/3.1%20SG.png)

- Aplique as configura√ß√µes abaixo e clique em *Create Security Group*
![<3.2 SG.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/3.2%20SG.png))
![<3.3 SG.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/3.3%20SG.png)

### **Criar a inst√¢ncia EC2**
- Em EC2, na se√ß√£o √† esquerda, clique em *Instances* e depois em "Launch Instances"
![<4 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4%20EC2.png)
![<4.0 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.0%20EC2.png)

- Aplique as configura√ß√µes abaixo:
![<4.1 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.1%20EC2.png)
![<4.2 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.2%20EC2.png)

- Para criar um "Key Pair", fa√ßa:
![<4.3 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.3%20EC2.png)

- Ap√≥s a cria√ß√£o, a chave ser√° baixada automaticamente para sua m√°quina. √â importante mant√™-la dispon√≠vel no momento da conex√£o com a inst√¢ncia. Se estiver usando o windows, com wsl, utilize o comando abaixo para copiar para a m√°quina Linux. Se j√° estiver utilizando Linux, pule esta etapa.
```cmd
scp \caminho_para_chave\[SUA_CHAVE].pem [USU√ÅRIO]@[IP_LINUX]:/home/[USU√ÅRIO]
```

- J√° no linux, aplique as permiss√µes para a chave:
```bash
chmod 400 [SUA_CHAVE].pem
```

- Continue as configura√ß√µes:
![<4.4 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.4%20EC2.png)
![<4.5 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.5%20EC2.png)

- Revise as configura√ß√µes e clique em *Launch Instance*
![<4.6 EC2.png>](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/4.6%20EC2.png)

## **Etapa 2: Conectando-se √† Inst√¢ncia**
Agora √© o momento de testar se todas as configura√ß√µes foram aplicadas corretamente.

- No seu terminal linux, utilize o comando abaixo:
```bash
ssh -i /local/da/chave/privada/[SUA_CHAVE].pem [USU√ÅRIO_EC2]@ip_publico
```
- Ser√° solicitado a confirma√ß√£o de acesso. Digite `yes` e aperte enter. Se tudo ocorrer como esperado, voc√™ estar√° conectado √† inst√¢ncia EC2

## **Etapa 3: Configura√ß√£o do Servidor Web**
### **1 - Instalar o e iniciar o Nginx**
No seu terminal, digite os seguintes comandos:
```bash
sudo apt-get update -y
sudo apt-get install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### **2 - Criar a P√°gina HTML**
Agora, vamos usar o editor Nano para criar a p√°gina HTML exibida ao acessar o servidor. Digite no terminal:

```bash
sudo nano /var/www/html/index.html
```

Adicione o conte√∫do de sua p√°gina ao editor. Abaixo, temos um exemplo de p√°gina b√°sica:
```html
<!DOCTYPE html>
<html>
<head><title>Servidor Web</title></head>
<body>
    <h1>Servidor Web configurado!</h1>
</body>
</html>
```
Para salvar as altera√ß√µes do Nano, digte `Ctrl + x`, `y` e aperte `enter`.

### **3 - Testar o Servidor**
Agora, acesse um navegador e coloque o IP p√∫blico da inst√¢ncia. Se tudo estiver configurado corretamente, voc√™ dever√° visualizar a p√°gina.

---

## **Etapa 4: Monitoramento e Notifica√ß√µes**
### **1 - Criar o Script de Monitoramento**
Agora, vamos configurar o monitoramento do servidor atrav√©s de um shell script.

No terminal, digite:
```bash
sudo nano /home/[USU√ÅRIO]/monitoramento.sh
```

Adicione no editor:
```bash
#!/usr/bin/env bash

LOCKFILE="/tmp/monitorar.lock"
LOGS="/var/log/monitorar.log"
BOT_TOKEN="[COLE AQUI O TOKEN GERADO PELO BOT]"
CHAT_ID="[COLE SEU CHAT_ID]"

if [ -e "$LOCKFILE" ]; then
    echo "O script j√° est√° em execu√ß√£o. Abortando."
    exit 1
fi

trap 'rm -f "$LOCKFILE"' EXIT

touch "$LOCKFILE"

if [ ! -f "$LOGS" ]; then
    mkdir -p $(dirname "$LOGS")
    touch "$LOGS"
fi

enviar_alerta() {
    local MENSAGEM="$1"
    curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d "chat_id=$CHAT_ID" \
        -d "text=$MENSAGEM" > /dev/null 2>&1
}

STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
TIME=$(date "+%d-%m-%Y %H:%M:%S")

case $STATUS in
    200)
        echo "$TIME - ‚úÖ Site online!" | tee -a "$LOGS"
        ;;
    400)
        MENSAGEM="$TIME - üö® ERRO 400: Requisi√ß√£o inv√°lida!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    401)
        MENSAGEM="$TIME - üö® ERRO 401: N√£o autorizado!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    403)
        MENSAGEM="$TIME - üö® ERRO 403: Acesso proibido!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    404)
        MENSAGEM="$TIME - üö® ERRO 404: P√°gina n√£o encontrada!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    408)
        MENSAGEM="$TIME - üö® ERRO 408: Tempo limite da requisi√ß√£o!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    429)
        MENSAGEM="$TIME - üö® ERRO 429: Muitas requisi√ß√µes!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    500)
        MENSAGEM="$TIME - üö® ERRO 500: Erro interno do servidor!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    502)
        MENSAGEM="$TIME - üö® ERRO 502: Gateway inv√°lido!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    503)
        MENSAGEM="$TIME - üö® ERRO 503: Servi√ßo indispon√≠vel!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    504)
        MENSAGEM="$TIME - üö® ERRO 504: Tempo limite do gateway!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
    *)
        MENSAGEM="$TIME - üö® ERRO $STATUS: Problema desconhecido!"
        echo "$MENSAGEM" | tee -a "$LOGS"
        enviar_alerta "$MENSAGEM"
        ;;
esac

rm -f "$LOCKFILE"
```

Agora, iremos alterar as permiss√µes do arquivo para que ele possa ser executado:
```bash
sudo chmod +x /home/[USU√ÅRIO]/monitoramento.sh
```

### **2 - Automatizar a Execu√ß√£o com Cron**
Agora vamos automatizar a execu√ß√£o do script com o Cron.
No terminal, digite:
```bash
sudo crontab -e
```
Escolha uma das 4 op√ß√µes de editor. Depois, adicione ao final do arquivo:
```bash
*/1 * * * * /home/ubuntu/monitorar.sh
```
Salve o arquivo. Dessa forma, o script ir√° verificar, a cada minuto, se o servidor est√° online. Caso ele esteja offline, uma notifica√ß√£o ser√° encaminhado ao Telegram.

---

## **Etapa 4: Testes**

### **1Ô∏è‚É£ Testar a Implementa√ß√£o**
- Acesse `http://IP_DA_INSTANCIA` para verificar o site.

- Pare o Nginx e aguarde 1 minuto:
  ```bash
  sudo systemctl stop nginx
  ```

- Verifique os logs:
  ```bash
  tail -f /var/log/monitoramento.log
  ```

- Confirme no Telegram o recebimento das notifica√ß√µes.

- Reinicie o Nginx:
  ```bash
  sudo systemctl start nginx
  ```
<br>
Voc√™ tamb√©m pode automatizar o teste criando um script. Para isso, no terminal, digite:

```bash
sudo nano /home/[USU√ÅRIO]/nginx_status.sh
```

Adicione no editor:
```bash
#!/usr/bin/env bash

# Verifica o status do servi√ßo nginx
STATUS=$(systemctl is-active nginx)

if [ "$STATUS" == "active" ]; then
    # Se o nginx est√° ativo, ent√£o desativa
    echo "O servi√ßo nginx est√° ativo. Desativando..."
    sudo systemctl stop nginx
else
    # Se o nginx est√° inativo, ent√£o ativa
    echo "O servi√ßo nginx est√° inativo. Ativando..."
    sudo systemctl start nginx
fi
```

Altere as permiss√µes do arquivo para que ele possa ser executado:
```bash
sudo chmod +x /home/[USU√ÅRIO]/nginx_status.sh
```

Vamos automatizar a execu√ß√£o:
```bash
sudo crontab -e
```

Adicione ao final do arquivo:
```bash
*/3 * * * * /home/ubuntu/nginx_status.sh
```
Salve o arquivo. Dessa forma, o script ir√° verificar, a cada 3 minutos, se o nginx est√° ativo. Caso ele esteja inativo, ele ir√° ativar. Se ele estiver ativo, ele ir√° desativar.

Para parar a execu√ß√£o, edite o arquivo cron e exclua a linha referente ao script.
---



## **Automatiza√ß√£o com User Data**
Uma outra forma de fazer as configura√ß√µes da inst√¢ncia √© a utiliza√ß√£o de *User Data* no momento da cria√ß√£o da inst√¢ncia.
Para isso, siga a [Etapa 1](#etapa-1-configura√ß√£o-do-ambiente), mas, antes de lan√ßar a inst√¢ncia, fa√ßa a seguinte configura√ß√£o:

- Expanda as configura√ß√µes avan√ßadas:
![5 USERDATA.png](https://github.com/vinicius-emanuelds/servidor-web-monitorado/blob/316fdcc66d7d88ac2ee91acc2ac84cabaf2f06fe/src/assets/to_README/5%20USERDATA.png)
Adicione este script no campo **"User Data"** ao criar a EC2:
```bash
#!/bin/bash
apt update -y && apt upgrade -y
apt install -y nginx
cat <<EOF > /var/www/html/index.html
<!DOCTYPE html>
<html><body><h1>Servidor via User Data</h1></body></html>
EOF
systemctl restart nginx
systemctl enable nginx
```

### **2Ô∏è‚É£ Infraestrutura com CloudFormation**
Crie um arquivo `infraestrutura.yaml`:
```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: "Provisiona uma VPC, sub-redes, EC2 e configura o servidor."
Resources:
  MinhaVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
  SubnetPublica:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MinhaVPC
      CidrBlock: "10.0.1.0/24"
      MapPublicIpOnLaunch: true
  MinhaEC2:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: "t2.micro"
      ImageId: "ami-0c55b159cbfafe1f0"
      SubnetId: !Ref SubnetPublica
      UserData:
        Fn::Base64: |
          #!/bin/bash
          apt update -y
          apt install -y nginx
          echo "<h1>Servidor via CloudFormation!</h1>" > /var/www/html/index.html
```

---

## **üéØ Conclus√£o**
Agora voc√™ tem um **servidor web totalmente configurado e monitorado**, com op√ß√µes de **automatiza√ß√£o** para facilitar a implanta√ß√£o.

**Diferenciais deste projeto:**
‚úî Configura√ß√£o manual e automatizada com **User Data**.
‚úî Infraestrutura como c√≥digo com **CloudFormation**.
‚úî Monitoramento inteligente com **notifica√ß√µes autom√°ticas**.

üöÄ **Agora √© sua vez de testar e personalizar!**

